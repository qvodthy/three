<!DOCTYPE html>
<html>
<head>
    <style type="text/css">
        html, body { height: 100%; margin: 0; padding: 0; }
        #map { height: 100%; }
    </style>
</head>
<body>
<div id="map"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script src="https://unpkg.com/@reactivex/rxjs@5.0.0-beta.12/dist/global/Rx.js"></script>
<script type="text/javascript">

    var God = {
        address: '上海市浦东新区孙环路177弄42栋501',
    };

    var suobi = {
        address: '复旦大学(邯郸校区)',
    };

    var dongbi = {
        address: '东华大学松江校区',
    };

    var players = [God, suobi, dongbi];

    var map;
    function initMap() {
        var service = new google.maps.DistanceMatrixService();
        let geocoder = new google.maps.Geocoder();

        Promise.all(players.map(player => new Promise((resolve, reject) => {
            geocoder.geocode({'address': player.address}, function(results, status) {
                if (status === google.maps.GeocoderStatus.OK) {
                    resolve(_.extend(player, {location: results[0].geometry.location}));
                } else {
                    reject('Geocode was not successful for the following reason: ' + status);
                }
            });
        }))).then(res => {
            let zoom = {
                lat: {
                    from: _.min(res, player => player.location.lat()).location.lat(),
                    to: _.max(res, player => player.location.lat()).location.lat(),
                },
                lng: {
                    from: _.min(res, player => player.location.lng()).location.lng(),
                    to: _.max(res, player => player.location.lng()).location.lng(),
                }
            };

            const SCALE = 5;

            Promise.all(_.chain(SCALE*SCALE)
                .range()
                .map(p => ({
                    lat: Math.floor(p/SCALE)*(zoom.lat.to - zoom.lat.from)/SCALE + zoom.lat.from,
                    lng: (p%SCALE)*(zoom.lng.to - zoom.lng.from)/SCALE + zoom.lng.from,
                }))
                .map(p => new Promise((resolve, reject) => {
                    service.getDistanceMatrix({
                        'origins': [p],
                        'destinations': res.map(player => player.location),
                        'travelMode': google.maps.TravelMode.TRANSIT}, function(results, status) {
                        if (status === google.maps.GeocoderStatus.OK) {
                            resolve(_.extend(p, {distance: _.chain(results.rows[0].elements)
                                .map(ele => ele.duration.value)
                                .reduce((prev, curr) => prev+curr)
                                .value()}));
                        } else {
                            reject('DistanceMatrixService was not successful for the following reason: ' + status);
                        }
                    });
                }))
                .value())
                .then(ress => console.log(
                    geocoder.geocode({'location': _.pick(_.min(ress, r => r.distance), ['lat', 'lng'])}, (results, status) => {
                        if (status === google.maps.GeocoderStatus.OK) {
                            console.log(results[0].formatted_address);
                        } else {
                            reject('Geocode was not successful for the following reason: ' + status);
                        }
                    })
                ));
        });

        map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: -34.397, lng: 150.644},
            zoom: 8
        });

//        geocodeAddress(geocoder);

    }


    function geocodeAddress(geocoder) {
        var address = ["复旦大学(邯郸校区)", "东华大学松江校区"];
        address.forEach(function (a) {
            geocoder.geocode({'address': a}, function(results, status) {
                if (status === google.maps.GeocoderStatus.OK) {
                    console.log(results[0].geometry.location.toString());
                } else {
                    alert('Geocode was not successful for the following reason: ' + status);
                }
            });
        });
    }

    function operator(input) {
        var geocoder = new google.maps.Geocoder();

        var output = Rx.Observable.create(function subscribe(observer) {
            input.subscribe({
                next: (v) => observer.next(10 * v),
                /*next: function (v) {
                    console.log('next');
                    geocoder.geocode({'address': v.address}, function(results, status) {
                        console.log('geocoder');
                        if (status === google.maps.GeocoderStatus.OK) {
                            v.location = results[0].geometry.location;
                            observer.next('map');
                        } else {
                            alert('Geocode was not successful for the following reason: ' + status);
                        }
                    });
                },*/
                next: v => 10,
                error: (err) => observer.error(err),
                complete: () => observer.complete()
            });
        });
        return output;
    }

</script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=此处填你们的KEY&callback=initMap">
</script>
</body>
</html>